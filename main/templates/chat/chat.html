{% extends 'main/base.html' %}
{% block title %}Chat with {{ other_user.username }} | AHMES Secondary School{% endblock %}

{% block content %}
<section class="section">
  <div class="container">
    <h2 class="section-title">Chat with {{ other_user.username }}</h2>
    <p class="section-subtitle">Send and receive messages in real-time.</p>
    
    <div class="row">
      <div class="col-12">
        <div class="card" data-aos="fade-up">
          <div class="card-body" id="messageContainer" style="max-height: 500px; overflow-y: auto;">
            {% for message in conversation.messages.all %}
              <div class="mb-3 {% if message.sender == request.user %}text-end{% else %}text-start{% endif %}" id="message-{{ message.id }}">
                <div class="d-inline-block p-3 rounded" style="background: {% if message.sender == request.user %}#e6f3ff{% else %}#f8f9fa{% endif %}; max-width: 70%;">
                  <p class="mb-1">{{ message.content }}</p>
                  <small class="text-muted">
                    {{ message.timestamp|date:"M d, Y H:i" }}
                    {% if message.sender == request.user %}
                      <span class="read-status">
                        {% if message.is_read %}
                          <i class="fas fa-check-double text-primary" title="Read"></i>
                        {% else %}
                          <i class="fas fa-check text-muted" title="Sent"></i>
                        {% endif %}
                      </span>
                    {% endif %}
                  </small>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="card-footer">
            <form method="post" action="{% url 'chat' conversation.id %}" id="messageForm">
              {% csrf_token %}
              <div class="input-group">
                <input type="text" name="content" class="form-control" placeholder="Type your message..." required id="messageInput">
                <button type="submit" class="btn btn-primary">Send</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Add Font Awesome for the check marks -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
document.addEventListener("DOMContentLoaded", function() {
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const messageContainer = document.getElementById("messageContainer");
  let lastMessageId = {{ conversation.messages.last.id|default:0 }};
  let isWindowFocused = true;
  
  window.addEventListener('focus', () => { isWindowFocused = true; });
  window.addEventListener('blur', () => { isWindowFocused = false; });

  function scrollToBottom() {
    messageContainer.scrollTop = messageContainer.scrollHeight;
  }

  function createMessageElement(data) {
    const isMe = data.sender === "{{ request.user.username }}";
    const date = new Date(data.timestamp);
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${isMe ? 'text-end' : 'text-start'}`;
    messageDiv.id = `message-${data.id}`;
    
    const messageContent = document.createElement('div');
    messageContent.className = 'd-inline-block p-3 rounded';
    messageContent.style.background = isMe ? '#e6f3ff' : '#f8f9fa';
    messageContent.style.maxWidth = '70%';
    
    const messageText = document.createElement('p');
    messageText.className = 'mb-1';
    messageText.textContent = data.content;
    
    const messageTime = document.createElement('small');
    messageTime.className = 'text-muted';
    messageTime.textContent = formattedTime;
    
    if (isMe) {
      const readStatus = document.createElement('span');
      readStatus.className = 'read-status';
      
      const checkIcon = document.createElement('i');
      checkIcon.className = data.is_read ? 'fas fa-check-double text-primary' : 'fas fa-check text-muted';
      checkIcon.title = data.is_read ? 'Read' : 'Sent';
      
      readStatus.appendChild(document.createTextNode(' '));
      readStatus.appendChild(checkIcon);
      messageTime.appendChild(readStatus);
    }
    
    messageContent.appendChild(messageText);
    messageContent.appendChild(messageTime);
    messageDiv.appendChild(messageContent);
    
    return messageDiv;
  }

  async function markMessageAsRead(messageId) {
    try {
      await fetch(`/messages/${messageId}/mark_read/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        }
      });
    } catch (error) {
      console.error('Error marking message as read:', error);
    }
  }

  async function checkNewMessages() {
    try {
      const response = await fetch(`/conversations/{{ conversation.id }}/messages/?last_id=${lastMessageId}`);
      const data = await response.json();
      
      if (data.messages?.length) {
        let shouldScroll = false;
        
        for (const msg of data.messages) {
          if (!document.getElementById(`message-${msg.id}`)) {
            const element = createMessageElement(msg);
            messageContainer.appendChild(element);
            lastMessageId = Math.max(lastMessageId, msg.id);
            shouldScroll = true;
            
            // Mark message as read if it's from the other user and window is focused
            if (!msg.is_me && !msg.is_read && isWindowFocused) {
              await markMessageAsRead(msg.id);
              // Update the read status visually
              const checkIcon = element.querySelector('.read-status i');
              if (checkIcon) {
                checkIcon.className = 'fas fa-check-double text-primary';
                checkIcon.title = 'Read';
              }
            }
          }
        }
        
        if (shouldScroll) {
          scrollToBottom();
        }
      }
    } catch (error) {
      console.error('Error checking messages:', error);
    }
  }

  messageForm?.addEventListener("submit", async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
      const response = await fetch(this.action, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await response.json();
      
      if (data.success) {
        const element = createMessageElement({
          id: data.message_id,
          content: data.content,
          timestamp: data.timestamp,
          sender: "{{ request.user.username }}",
          is_read: false
        });
        messageContainer.appendChild(element);
        messageInput.value = '';
        scrollToBottom();
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });

  // Check messages every 2 seconds when focused, 5 seconds when not
  setInterval(checkNewMessages, isWindowFocused ? 2000 : 5000);
  checkNewMessages();
  scrollToBottom();
});
</script>

<style>
.read-status i {
  margin-left: 5px;
}
</style>
{% endblock %}